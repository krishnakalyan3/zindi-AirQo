import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import warnings
warnings.filterwarnings('ignore')
from sklearn.model_selection import KFold,StratifiedKFold, TimeSeriesSplit
from sklearn.metrics import mean_squared_error
from math import sqrt 
from sklearn.metrics import mean_squared_error 
from sklearn.model_selection import KFold, train_test_split
import requests
from io import StringIO 
from catboost import CatBoostRegressor
pd.set_option("display.max_rows", 100)
pd.set_option("display.max_columns", 100)

vars_cat = ['min_atmos_press',
 'median_atmos_press',
 'mean_atmos_press',
 'median_wind_spd',
 'newtemp64',
 'atmospherepressure33',
 'min_temp',
 'atmospherepressure56',
 'median_wind_dir',
 'atmospherepressure92',
 'max_wind_spd',
 'min_wind_spd',
 'mean_wind_dir',
 'max_rel_humidity',
 'newtemp16',
 'mean_precip',
 'atmospherepressure105',
 'max_wind_dir',
 'ptp_wind_spd',
 'var_wind_dir',
 'median_temp',
 'newtemp39',
 'ptp_atmos_press',
 'newtemp0',
 'max_temp',
 'newtemp23',
 'windspeed119',
 'location',
 'newtemp92',
 'atmospherepressure34',
 'newtemp57',
 'newtemp2',
 'atmospherepressure104',
 'min_wind_dir',
 'atmospherepressure32',
 'atmospherepressure20',
 'std_wind_dir',
 'windspeed95',
 'newtemp103',
 'ptp_precip',
 'atmospherepressure8',
 'var_rel_humidity',
 'newtemp73',
 'newtemp104',
 'newtemp49',
 'newtemp25',
 'atmospherepressure86',
 'min_rel_humidity',
 'ptp_rel_humidity',
 'newrel_humidity34',
 'atmospherepressure2',
 'newtemp29',
 'ptp_wind_dir',
 'windspeed47',
 'newrel_humidity32',
 'windspeed71',
 'newtemp3',
 'newwind_dir103',
 'atmospherepressure12',
 'max_precip',
 'var_temp',
 'max_atmos_press',
 'atmospherepressure44',
 'std_atmos_press',
 'newtemp81',
 'newtemp115',
 'std_precip',
 'std_rel_humidity',
 'windspeed120',
 'atmospherepressure116',
 'newtemp120',
 'newrel_humidity2',
 'newrel_humidity0',
 'newrel_humidity114',
 'newtemp58',
 'newtemp66',
 'newwind_dir56',
 'atmospherepressure87',
 'newrel_humidity11',
 'ptp_temp',
 'newrel_humidity78',
 'atmospherepressure98',
 'newrel_humidity8',
 'median_rel_humidity',
 'mean_temp',
 'newtemp74',
 'atmospherepressure9',
 'newtemp54',
 'newtemp47',
 'newtemp52',
 'newrel_humidity59',
 'newtemp50',
 'atmospherepressure7',
 'std_temp',
 'newwind_dir90',
 'newwind_dir54',
 'atmospherepressure3',
 'mean_wind_spd',
 'newrel_humidity10',
 'mean_rel_humidity',
 'newtemp101',
 'newwind_dir3',
 'newrel_humidity1',
 'newtemp41',
 'newwind_dir120',
 'newrel_humidity95',
 'atmospherepressure85',
 'atmospherepressure62',
 'newtemp102',
 'newrel_humidity6',
 'atmospherepressure68',
 'newwind_dir29',
 'newrel_humidity120',
 'newtemp20',
 'newtemp87',
 'var_precip',
 'atmospherepressure103',
 'newtemp119',
 'newwind_dir102',
 'var_atmos_press',
 'newtemp78',
 'newtemp89',
 'newrel_humidity41',
 'newrel_humidity48',
 'windspeed115',
 'newtemp95',
 'newtemp112',
 'newwind_dir53',
 'atmospherepressure50',
 'windspeed108',
 'newrel_humidity50',
 'newrel_humidity102',
 'std_wind_spd',
 'atmospherepressure39',
 'newtemp30',
 'newwind_dir78',
 'newtemp90',
 'windspeed107',
 'atmospherepressure63',
 'newtemp32',
 'newtemp75',
 'windspeed31',
 'newtemp48',
 'windspeed4',
 'newtemp1',
 'windspeed80',
 'newwind_dir52',
 'atmospherepressure109',
 'newtemp97',
 'newtemp85',
 'windspeed49',
 'newwind_dir32',
 'newtemp63',
 'windspeed56',
 'windspeed5',
 'newtemp76',
 'newrel_humidity103',
 'atmospherepressure1',
 'newtemp70',
 'newrel_humidity17',
 'newtemp96',
 'atmospherepressure25',
 'windspeed42',
 'newrel_humidity26',
 'atmospherepressure120',
 'newrel_humidity61',
 'newtemp77',
 'newtemp46',
 'windspeed97',
 'newrel_humidity98',
 'newtemp72',
 'newrel_humidity33',
 'newrel_humidity115',
 'newtemp15',
 'windspeed32',
 'atmospherepressure10',
 'newwind_dir119',
 'newwind_dir118',
 'atmospherepressure80',
 'newtemp8',
 'windspeed10',
 'atmospherepressure30',
 'newrel_humidity112',
 'newtemp55',
 'newwind_dir104',
 'newwind_dir100',
 'newrel_humidity35',
 'atmospherepressure110',
 'newwind_dir57',
 'atmospherepressure61',
 'newtemp17',
 'newwind_dir30',
 'atmospherepressure112',
 'windspeed48',
 'newwind_dir25',
 'atmospherepressure113',
 'newrel_humidity12',
 'newwind_dir42',
 'newrel_humidity91',
 'newtemp9',
 'windspeed23',
 'atmospherepressure27',
 'newtemp13',
 'newrel_humidity13',
 'newrel_humidity79',
 'newwind_dir5',
 'newrel_humidity85',
 'newwind_dir1',
 'atmospherepressure69',
 'windspeed79',
 'newrel_humidity84',
 'newrel_humidity9',
 'newrel_humidity101',
 'newtemp67',
 'newrel_humidity119',
 'windspeed51',
 'newwind_dir89',
 'newrel_humidity67',
 'newwind_dir99',
 'windspeed98',
 'newtemp11',
 'windspeed118',
 'newtemp99',
 'newtemp56',
 'newwind_dir101',
 'newtemp43',
 'newrel_humidity113',
 'newwind_dir105',
 'newtemp10',
 'newrel_humidity24',
 'newrel_humidity25',
 'newtemp6',
 'newrel_humidity56',
 'newrel_humidity46',
 'newrel_humidity110',
 'atmospherepressure38',
 'atmospherepressure114',
 'newrel_humidity47',
 'newwind_dir2',
 'windspeed41',
 'atmospherepressure14',
 'windspeed46',
 'newrel_humidity62',
 'atmospherepressure16',
 'atmospherepressure117',
 'newtemp65',
 'windspeed78',
 'newrel_humidity93',
 'newrel_humidity96',
 'newwind_dir21',
 'atmospherepressure84',
 'windspeed14',
 'newrel_humidity81',
 'windspeed0',
 'windspeed9',
 'newtemp14',
 'newrel_humidity100',
 'newprecip66',
 'newtemp21',
 'atmospherepressure93',
 'newwind_dir71',
 'newrel_humidity89',
 'newprecip56',
 'windspeed99',
 'newrel_humidity94',
 'windspeed30',
 'newtemp114',
 'newwind_dir26',
 'atmospherepressure107',
 'windspeed16',
 'newwind_dir17',
 'atmospherepressure119',
 'atmospherepressure26',
 'newtemp79',
 'newrel_humidity7',
 'newtemp98',
 'newwind_dir115',
 'windspeed113',
 'newwind_dir34',
 'newrel_humidity105',
 'atmospherepressure89',
 'newtemp80',
 'windspeed59',
 'newrel_humidity14',
 'atmospherepressure59',
 'newprecip81',
 'newtemp26',
 'windspeed105',
 'windspeed62',
 'newwind_dir24',
 'atmospherepressure102',
 'atmospherepressure65',
 'newrel_humidity109',
 'windspeed27',
 'newrel_humidity65',
 'newtemp100',
 'newwind_dir4',
 'newrel_humidity22',
 'windspeed43',
 'atmospherepressure48',
 'newwind_dir77',
 'newrel_humidity31',
 'newrel_humidity69',
 'newrel_humidity71',
 'newwind_dir9',
 'windspeed104',
 'newwind_dir76',
 'newwind_dir27',
 'atmospherepressure88',
 'windspeed72',
 'newwind_dir61',
 'newrel_humidity82',
 'windspeed67',
 'newrel_humidity44',
 'newtemp18',
 'newrel_humidity29',
 'newwind_dir48',
 'windspeed87',
 'newrel_humidity106',
 'newwind_dir7',
 'newtemp45',
 'atmospherepressure118',
 'newwind_dir12',
 'newwind_dir47',
 'newrel_humidity117',
 'newtemp31',
 'windspeed109',
 'newwind_dir55',
 'newrel_humidity58',
 'windspeed68',
 'newrel_humidity87',
 'newwind_dir95',
 'newwind_dir59',
 'windspeed17',
 'newtemp12',
 'newwind_dir22',
 'newtemp113',
 'newtemp7',
 'newrel_humidity92',
 'newwind_dir85',
 'newwind_dir8',
 'newwind_dir82',
 'newtemp109',
 'windspeed36',
 'newwind_dir65',
 'newwind_dir6',
 'windspeed38',
 'windspeed20',
 'windspeed8',
 'newtemp107',
 'newwind_dir51',
 'newrel_humidity55',
 'newtemp88',
 'windspeed70',
 'newwind_dir35',
 'newrel_humidity86',
 'windspeed13',
 'atmospherepressure52',
 'atmospherepressure41',
 'atmospherepressure73',
 'newwind_dir114',
 'newrel_humidity118',
 'newtemp5',
 'atmospherepressure99',
 'newprecip104',
 'newprecip68',
 'newrel_humidity19',
 'newtemp61',
 'newprecip29',
 'atmospherepressure15',
 'newwind_dir109',
 'atmospherepressure97',
 'windspeed73',
 'newrel_humidity108',
 'newwind_dir96',
 'newwind_dir33',
 'windspeed3',
 'newwind_dir66',
 'newtemp71',
 'newwind_dir86',
 'newrel_humidity111',
 'newrel_humidity80',
 'newwind_dir45',
 'newwind_dir116',
 'newwind_dir15',
 'newtemp27',
 'atmospherepressure47',
 'windspeed26',
 'newtemp108',
 'windspeed25',
 'windspeed92',
 'newrel_humidity4',
 'newwind_dir46',
 'newwind_dir80',
 'newrel_humidity90',
 'atmospherepressure96',
 'var_wind_spd',
 'newtemp38',
 'newwind_dir36',
 'newwind_dir58',
 'newtemp62',
 'windspeed66',
 'windspeed55',
 'newrel_humidity20',
 'windspeed6',
 'newprecip54',
 'newrel_humidity75',
 'newwind_dir16',
 'newprecip35',
 'newprecip1',
 'newwind_dir18',
 'newwind_dir50',
 'newwind_dir81',
 'newwind_dir94',
 'newtemp106',
 'newwind_dir13',
 'newwind_dir60',
 'atmospherepressure90',
 'newwind_dir93',
 'newprecip120',
 'atmospherepressure45',
 'windspeed114',
 'newrel_humidity97',
 'windspeed7',
 'newprecip11',
 'atmospherepressure18',
 'windspeed96',
 'newrel_humidity27',
 'atmospherepressure64',
 'newtemp33',
 'newrel_humidity43',
 'newrel_humidity49',
 'atmospherepressure21',
 'newrel_humidity64',
 'newwind_dir41',
 'windspeed81',
 'newtemp40',
 'newtemp111',
 'newwind_dir40',
 'newprecip57',
 'newwind_dir113',
 'newtemp82',
 'newwind_dir23',
 'windspeed22',
 'atmospherepressure106',
 'newprecip19',
 'windspeed33',
 'newrel_humidity83',
 'newtemp19',
 'newprecip98',
 'newwind_dir10',
 'windspeed12',
 'newrel_humidity40',
 'newprecip31',
 'atmospherepressure6',
 'newprecip86',
 'newwind_dir72',
 'atmospherepressure101',
 'windspeed85',
 'windspeed50',
 'newwind_dir20',
 'newrel_humidity36',
 'newrel_humidity57',
 'atmospherepressure91',
 'newprecip45',
 'atmospherepressure53',
 'newrel_humidity99',
 'newtemp24',
 'newrel_humidity52',
 'newrel_humidity30',
 'newwind_dir39',
 'newrel_humidity15',
 'newprecip7',
 'newrel_humidity60',
 'windspeed11',
 'windspeed2',
 'newrel_humidity18',
 'newwind_dir44',
 'atmospherepressure24',
 'atmospherepressure100',
 'newwind_dir28',
 'newwind_dir70',
 'newrel_humidity21',
 'windspeed76',
 'newwind_dir98',
 'windspeed34',
 'windspeed83',
 'windspeed63',
 'windspeed37',
 'newtemp94',
 'newprecip17',
 'atmospherepressure76',
 'windspeed88',
 'atmospherepressure81',
 'newrel_humidity116',
 'newwind_dir106',
 'newwind_dir88',
 'newwind_dir79',
 'windspeed91',
 'newwind_dir87',
 'atmospherepressure17',
 'windspeed57',
 'newwind_dir97',
 'atmospherepressure36',
 'atmospherepressure4',
 'windspeed18',
 'newrel_humidity70',
 'newprecip58',
 'newwind_dir74',
 'atmospherepressure108',
 'newrel_humidity38',
 'newprecip119',
 'newtemp36',
 'atmospherepressure75',
 'newwind_dir37',
 'windspeed90',
 'newwind_dir11',
 'windspeed117',
 'newrel_humidity72',
 'newrel_humidity45',
 'windspeed28',
 'newrel_humidity54',
 'newtemp110',
 'newrel_humidity39',
 'newwind_dir75',
 'atmospherepressure78',
 'newwind_dir62',
 'atmospherepressure74',
 'newprecip111',
 'newtemp35',
 'newprecip8',
 'newwind_dir43',
 'newprecip91',
 'newprecip85',
 'windspeed86',
 'newtemp105',
 'newprecip32',
 'atmospherepressure67',
 'atmospherepressure11',
 'atmospherepressure43',
 'atmospherepressure77',
 'newwind_dir108',
 'newprecip10',
 'atmospherepressure19',
 'newrel_humidity88',
 'newwind_dir64',
 'newrel_humidity5',
 'windspeed1',
 'newwind_dir63',
 'newrel_humidity77',
 'windspeed39',
 'newwind_dir14',
 'newprecip73',
 'newtemp91',
 'windspeed101',
 'newwind_dir31',
 'atmospherepressure51',
 'atmospherepressure115',
 'newtemp28',
 'newwind_dir83',
 'windspeed89',
 'newtemp51',
 'atmospherepressure95',
 'newprecip37',
 'windspeed100',
 'newtemp34',
 'atmospherepressure37',
 'newtemp4',
 'newprecip115',
 'newwind_dir49',
 'windspeed102',
 'windspeed58',
 'newrel_humidity28',
 'windspeed93',
 'newwind_dir19',
 'newwind_dir0',
 'windspeed116',
 'newwind_dir67',
 'newprecip62',
 'newwind_dir84',
 'newtemp116',
 'newprecip4',
 'newwind_dir117',
 'newtemp44',
 'newrel_humidity107',
 'newprecip14',
 'atmospherepressure57',
 'newwind_dir69',
 'newrel_humidity68',
 'atmospherepressure70',
 'windspeed44',
 'newwind_dir38',
 'newrel_humidity104',
 'atmospherepressure58',
 'newtemp68',
 'windspeed84',
 'newwind_dir107',
 'windspeed21',
 'newprecip12',
 'newtemp83',
 'newprecip34',
 'atmospherepressure79',
 'newprecip71',
 'windspeed40',
 'newprecip23',
 'newprecip82',
 'windspeed110',
 'windspeed29',
 'windspeed74',
 'newtemp117',
 'newprecip107',
 'newprecip117',
 'newrel_humidity16',
 'newprecip38',
 'atmospherepressure49',
 'atmospherepressure13',
 'newtemp59',
 'newprecip75',
 'newtemp37',
 'windspeed82',
 'atmospherepressure0',
 'atmospherepressure111',
 'newprecip53',
 'newrel_humidity23',
 'newrel_humidity73',
 'windspeed24',
 'newprecip51',
 'newprecip47',
 'newwind_dir110',
 'atmospherepressure55',
 'newrel_humidity74',
 'atmospherepressure94',
 'newprecip16',
 'newtemp118',
 'windspeed64',
 'newrel_humidity76',
 'newtemp84',
 'newwind_dir91',
 'newtemp60',
 'newprecip3',
 'newprecip36',
 'windspeed77',
 'newrel_humidity51',
 'newprecip69',
 'newprecip60',
 'newrel_humidity66',
 'newrel_humidity37',
 'windspeed60',
 'windspeed94',
 'newprecip26',
 'windspeed65',
 'newtemp69',
 'newprecip41',
 'atmospherepressure54',
 'newwind_dir73',
 'newprecip110',
 'newwind_dir111',
 'newwind_dir92',
 'atmospherepressure71',
 'newprecip114',
 'newwind_dir112',
 'windspeed103',
 'newprecip84',
 'windspeed75',
 'windspeed53',
 'atmospherepressure82',
 'newprecip6',
 'newprecip101',
 'atmospherepressure40',
 'newprecip43',
 'windspeed52',
 'newprecip0',
 'windspeed19',
 'atmospherepressure72',
 'newprecip5',
 'atmospherepressure23',
 'newprecip118',
 'atmospherepressure31',
 'newprecip44',
 'newprecip46',
 'newprecip55',
 'newprecip103',
 'windspeed54',
 'newprecip113',
 'newprecip83',
 'newtemp42',
 'newprecip116',
 'newprecip33',
 'newtemp53',
 'newtemp86',
 'newprecip97',
 'newprecip89',
 'windspeed111',
 'newprecip109',
 'atmospherepressure60',
 'newwind_dir68',
 'newprecip87',
 'windspeed15',
 'windspeed112',
 'newprecip76',
 'windspeed35',
 'newprecip105',
 'newprecip64',
 'atmospherepressure35',
 'atmospherepressure42',
 'newprecip28',
 'newtemp93',
 'newprecip65',
 'newprecip90',
 'newprecip52',
 'newprecip78',
 'windspeed45',
 'newprecip9',
 'newprecip74',
 'newprecip39',
 'atmospherepressure66',
 'newprecip72',
 'atmospherepressure46',
 'newrel_humidity3',
 'newprecip2',
 'newprecip49',
 'newtemp22',
 'atmospherepressure22',
 'newprecip106',
 'windspeed69',
 'newprecip80',
 'newprecip59',
 'windspeed106',
 'newrel_humidity63',
 'atmospherepressure83',
 'newprecip88',
 'newprecip61',
 'newprecip92',
 'atmospherepressure28',
 'newrel_humidity53',
 'newprecip18',
 'newprecip22',
 'newprecip94',
 'newrel_humidity42',
 'newprecip20',
 'newprecip77',
 'atmospherepressure5',
 'newprecip30',
 'newprecip67',
 'newprecip95',
 'windspeed61',
 'newprecip100',
 'newprecip96',
 'newprecip42',
 'newprecip21',
 'newprecip102',
 'newprecip25',
 'newprecip112',
 'newprecip93',
 'newprecip13',
 'newprecip108',
 'newprecip70',
 'newprecip79',
 'newprecip24',
 'newprecip99',
 'newprecip27',
 'newprecip15',
 'newprecip50',
 'newprecip48',
 'newprecip63',
 'atmospherepressure29',
 'newprecip40',
 'median_precip']


def catboost_helper(select_cols, X, y, test):
    X = X.filter(select_cols)
    test = test.filter(select_cols)
    errcb2=[]
    y_pred_totcb2=[]
    
    fold=KFold(n_splits=20)#15#5#10
    i=1
    for train_index, test_index in fold.split(X,y):
        X_train, X_test = X.iloc[train_index], X.iloc[test_index]
        y_train, y_test = y.iloc[train_index], y.iloc[test_index]
        m2  = CatBoostRegressor(n_estimators=7000, eval_metric='RMSE',learning_rate=0.1, random_seed= 1234, use_best_model=True)
        m2.fit(X_train,y_train,eval_set=[(X_train,y_train),(X_test, y_test)], early_stopping_rounds=100,verbose=100,)#erly100
        preds=m2.predict(X_test)
        print("err: ",np.sqrt(mean_squared_error(y_test,preds)))
        errcb2.append(np.sqrt(mean_squared_error(y_test,preds)))
        p2 = m2.predict(test)
        y_pred_totcb2.append(p2)
    
    return y_pred_totcb2, np.mean(errcb2)

def catboost_helper_fold(select_cols, fold, X, y, test):
    X = X.filter(select_cols)
    test = test.filter(select_cols)
    errcb2=[]
    y_pred_totcb2=[]
    
    fold=KFold(n_splits=fold)#15#5#10
    i=1
    for train_index, test_index in fold.split(X,y):
        X_train, X_test = X.iloc[train_index], X.iloc[test_index]
        y_train, y_test = y.iloc[train_index], y.iloc[test_index]
        m2  = CatBoostRegressor(n_estimators=7000, eval_metric='RMSE',learning_rate=0.1, 
                                random_seed= 1337, use_best_model=True)
        m2.fit(X_train,y_train,eval_set=[(X_train,y_train),(X_test, y_test)], early_stopping_rounds=100,verbose=100,)#erly100
        preds=m2.predict(X_test)
        print("err: ",np.sqrt(mean_squared_error(y_test,preds)))
        errcb2.append(np.sqrt(mean_squared_error(y_test,preds)))
        p2 = m2.predict(test)
        y_pred_totcb2.append(p2)
    
    return y_pred_totcb2, np.mean(errcb2)


def write_csv(test, y_pred_totcb2, err):
    from datetime import datetime
    exp_time = str(datetime.now().replace(second=0, microsecond=0)).replace(" ", "_")
    exp_name = "catboost-gridf"
    csv_file_name = "{:.4f}_{}_{}".format(err, exp_name, exp_time)
    test_id  = test['ID']
    d = {'ID': test_id, 'target': np.mean(y_pred_totcb2, 0)}
    sub = pd.DataFrame(data=d)
    sub = sub[['ID', 'target']]
    SUB = "/root/air/sub/grid1/"
    sub.to_csv(SUB+csv_file_name+'.csv', index=False)
